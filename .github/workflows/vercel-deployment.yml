name: Vercel Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install Vercel CLI
        run: npm install -g vercel

      - name: Deploy to Vercel
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_S3: ${{ secrets.NEXT_PUBLIC_SUPABASE_S3 }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          NEXT_PUBLIC_PHONE_NUMBER: ${{ secrets.NEXT_PUBLIC_PHONE_NUMBER }}
          NEXT_PUBLIC_EMAIL: ${{ secrets.NEXT_PUBLIC_EMAIL }}
        run: |
          vercel pull --yes --environment=production --token=$VERCEL_TOKEN
          vercel build --prod --token=$VERCEL_TOKEN
          vercel deploy --prebuilt --prod --token=$VERCEL_TOKEN

      - name: Notify success deployment
        if: success()
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{"text": "✅ Deployment for senkou-hero.vercel.app successfully completed!"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Notify failed deployment
        if: failure()
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{"text": "❌ Deployment for senkou-hero.vercel.app failed!"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }}
